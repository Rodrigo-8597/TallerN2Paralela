#include <iostream>
#include <pqxx/pqxx> 
#include <string>
#include <fstream>
#include <sstream>
using namespace std;
using namespace pqxx;

int main(int argc, char* argv[]) {
   char * sql;
   std::string rut,nem,ranking,matematicas,lenguaje,ciencias,historia;
   int nemn,rankingn,matematicasn,lenguajen,cienciasn,historian;
   double promedio;
   std::ofstream archivo_promedios;
   archivo_promedios.open("/home/rorro/Descargas/psu.txt");
   try {
      connection C("dbname = pssdb user = pss password = pss hostaddr = 192.168.0.27");
      if (C.is_open()) {
         cout << "Opened database successfully: " << C.dbname() << endl;
      } else {
         cout << "Can't open database" << endl;
         return 1;
      }

      /* Create SQL statement */
      sql = "SELECT * from puntajes";

      /* Create a non-transactional object. */
      nontransaction N(C);
      
      /* Execute SQL query */
      result R( N.exec( sql ));
      
      /* List down all the records */
      for (result::const_iterator c = R.begin();c < R.end(); c++) {
        rut= sql[c][1].as<std::string>();

        nem= sql[c][2].as<std::string>();
        std::istringstream(nem) >> nemn;
        ranking= sql[c][3].as<std::string>();
        std::istringstream(ranking) >> rankingn;
        matematicas= sql[c][4].as<std::string>();
        std::istringstream(matematicas) >> matematicasn;
        lenguaje= sql[c][5].as<std::string>();
        std::istringstream(lenguaje) >> lenguajen;
        ciencias= sql[c][6].as<std::string>();
        std::istringstream(ciencias) >> cienciasn;
        historia= sql[c][7].as<std::string>();
        std::istringstream(historia) >> historian;

        promedio=double((nemn+rankingn+matematicasn+lenguajen+cienciasn+historian)/6);
        archivo_promedios<<rut<<";"<<promedio<<endl;
        promedio=0;
      }
      cout << "Operation done successfully" << endl;
      C.disconnect();
      archivo_promedios.close();
   } catch (const std::exception &e) {
      cerr << e.what() << std::endl;
      return 1;
   }

   return 0;
}
